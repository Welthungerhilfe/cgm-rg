# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker


# specific path
trigger:
  branches:
    include:
    - develop
  paths:
    include:
    - src/*
    exclude:
    - README.md

# specific path
pr:
  branches:
    include:
    - develop
  paths:
    include:
    - src/*
    exclude:
    - README.md

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '01d8e191-0132-47ae-bec0-cbdcf8e96a09'
  imageRepository: 'cgmresultgeneration'
  dockerId: 'cgmrgtest'
  containerRegistry: 'cgmrgtest.azurecr.io'
  dockerfilePath: 'Dockerfile.build'
  tag: '$(Build.BuildId)'
  buildConfiguration: 'BuildAndTest'  
  # Agent VM image name
  vmImageName: 'ubuntu-latest'

# Build Docker image for this app, to be published to Docker Registry
pool:
  vmImage: $(vmImageName)

steps:
- script: docker build -f $(dockerfilePath) -t $(dockerId)/build:$(tag) .
  displayName: 'Build'

- bash: |
    docker run -e ACC_NAME=$(ACC_NAME) -e ACC_KEY=$(ACC_KEY) --name test -d $(dockerId)/build:$(tag)
    docker stop test
    docker logs -t test
    docker cp test:/app/test-output.xml $(System.DefaultWorkingDirectory)
  displayName: 'Copy Test Report'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit' # Options: JUnit, NUnit, VSTest, xUnit, cTest
    testResultsFiles: '**/test-output.xml' 
    failTaskOnFailedTests: true # Optional
    #searchFolder: '$(System.DefaultWorkingDirectory)' # Optional
    #mergeTestResults: false # Optional
    #testRunTitle: # Optional
    #buildPlatform: # Optional
    #buildConfiguration: # Optional
    #publishRunAttachments: true # Optional
